 # ğŸ§  Linuxì—ì„œ Shared Memory êµ¬í˜„í•˜ê¸° (Windows SharedMemory ìŠ¤íƒ€ì¼)
ì´ ë¬¸ì„œëŠ” Linux í™˜ê²½ì—ì„œ Windowsì˜ SharedMemoryì™€ ìœ ì‚¬í•œ ë°©ì‹ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ê°„ ë©”ëª¨ë¦¬ ê³µìœ ë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ë²•ì„ ì„¤ëª…í•©ë‹ˆë‹¤.\ POSIX ê³µìœ  ë©”ëª¨ë¦¬ APIë¥¼ í™œìš©í•˜ë©°, shm_open, ftruncate, mmap, munmap, shm_unlink ë“±ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.

## ğŸ“¦ ì£¼ìš” API ê°œìš”
|------|-----|
| í•¨ìˆ˜ | ì„¤ëª… | 
| shm_open | ê³µìœ  ë©”ëª¨ë¦¬ ê°ì²´ ìƒì„± ë˜ëŠ” ì—´ê¸° | 
| ftruncate | ê³µìœ  ë©”ëª¨ë¦¬ í¬ê¸° ì„¤ì • | 
| mmap | ê³µìœ  ë©”ëª¨ë¦¬ë¥¼ í”„ë¡œì„¸ìŠ¤ ì£¼ì†Œ ê³µê°„ì— ë§¤í•‘ | 
| munmap | ë§¤í•‘ í•´ì œ | 
| shm_unlink | ê³µìœ  ë©”ëª¨ë¦¬ ê°ì²´ ì œê±° | 



## ğŸ§¾ ì†ŒìŠ¤ ì½”ë“œ ì„¤ëª…
```cpp
#include <iostream>
#include <fcntl.h>      // O_CREAT, O_RDWR
#include <sys/mman.h>   // shm_open, mmap, PROT_*, MAP_*
#include <unistd.h>     // ftruncate, close
#include <cstring>      // memcpy
#include <sys/stat.h>   // mode constants

const char* SHM_NAME = "/my_shared_memory";
const size_t SHM_SIZE = 4096;

int main() {
    // 1. ê³µìœ  ë©”ëª¨ë¦¬ ê°ì²´ ìƒì„± ë˜ëŠ” ì—´ê¸°
    int shm_fd = shm_open(SHM_NAME, O_CREAT | O_RDWR, 0666);
    if (shm_fd == -1) {
        std::cerr << "Failed to open shared memory" << std::endl;
        return 1;
    }

    // 2. ê³µìœ  ë©”ëª¨ë¦¬ í¬ê¸° ì„¤ì •
    if (ftruncate(shm_fd, SHM_SIZE) == -1) {
        std::cerr << "Failed to set size" << std::endl;
        return 1;
    }

    // 3. ë©”ëª¨ë¦¬ ë§¤í•‘
    void* ptr = mmap(0, SHM_SIZE, PROT_READ | PROT_WRITE, MAP_SHARED, shm_fd, 0);
    if (ptr == MAP_FAILED) {
        std::cerr << "Failed to map memory" << std::endl;
        return 1;
    }

    // 4. ë°ì´í„° ì“°ê¸°
    const char* message = "Hello from shared memory!";
    memcpy(ptr, message, strlen(message) + 1);

    std::cout << "Message written to shared memory: " << static_cast<char*>(ptr) << std::endl;

    // 5. ë©”ëª¨ë¦¬ ë§¤í•‘ í•´ì œ
    munmap(ptr, SHM_SIZE);

    // 6. íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ë‹«ê¸°
    close(shm_fd);

    // 7. ê³µìœ  ë©”ëª¨ë¦¬ ê°ì²´ ì œê±° (ì„ íƒì )
    // shm_unlink(SHM_NAME);

    return 0;
}
```
## ì‹¤ì „ ì˜ˆì œ
```cpp
// First í”„ë¡œì„¸ìŠ¤ - ê³µìœ  ë©”ëª¨ë¦¬ Create ë° Write
////////////////////////////////////
//     First Process Shared Memory    
////////////////////////////////////
#include <iostream>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>
#include <unistd.h>
 
#define  KEY_NUM   1234
#define  MEM_SIZE  4096
 
using namespace std;
 
int shmid;
static int SharedMemoryCreate();
static int SharedMemoryWrite(char *shareddata, int size);
static int SharedMemoryRead(char *sMemory);
static int SharedMemoryFree(void);
 
int main(int argc, char *argv[])
{
    char buffer[MEM_SIZE] = {1,};
    
    SharedMemoryCreate();
    sleep(5);
    
    SharedMemoryWrite(buffer, sizeof(buffer));
    return 0;
}
 
static int SharedMemoryCreate()
{
    if((shmid = shmget((key_t)KEY_NUM, MEM_SIZE, IPC_CREAT| IPC_EXCL | 0666)) == -1) {
        printf("There was shared memory.");
        
        shmid = shmget((key_t)KEY_NUM, MEM_SIZE, IPC_CREAT| 0666);
        
        if(shmid == -1)
        {
            perror("Shared memory create fail");
            return 1;
        }
        else
        {
            SharedMemoryFree();
            shmid = shmget((key_t)KEY_NUM, MEM_SIZE, IPC_CREAT| 0666);
            
            if(shmid == -1)
            {
                perror("Shared memory create fail");
                return 1;
            }
        }
    }
    
    return 0;
}
 
static int SharedMemoryWrite(char *shareddata, int size)
{
    void *shmaddr;
    if(size > MEM_SIZE)
    {
        printf("Shared memory size over");
        return 1;
    }
    
    if((shmaddr = shmat(shmid, (void *)0, 0)) == (void *)-1) 
    {
        perror("Shmat failed");
        return 1;
    }
    
    memcpy((char *)shmaddr, shareddata, size);
    
    if(shmdt(shmaddr) == -1) 
    {
        perror("Shmdt failed");
        return 1;
    }
    return 0;
}
 
static int SharedMemoryRead(char *sMemory)
{
    void *shmaddr;
    char mess[MEM_SIZE] = {0};
    
    if((shmaddr = shmat(shmid, (void *)0, 0)) == (void *)-1)
    {
        perror("Shmat failed");
        return 1;
    }
    
    memcpy(sMemory, (char *)shmaddr, sizeof(mess));
    
    if(shmdt(shmaddr) == -1)
    {
        perror("Shmdt failed");
        return 1;
    }
    return 0;
}
 
static int SharedMemoryFree(void)
{
    if(shmctl(shmid, IPC_RMID, 0) == -1) 
    {
        perror("Shmctl failed");
        return 1;
    }
    
    printf("Shared memory end");
    return 0;
}
 


// Second í”„ë¡œì„¸ìŠ¤ - ê³µìœ  ë©”ëª¨ë¦¬ Connect ë° Read
///////////////////////////////////////
//    Second Process Shared Memory    
////////////////////////////////////////
#include <iostream>
#include <sys/ipc.h>
#include <sys/shm.h>
#include <string.h>

#define  KEY_NUM   1234
#define  MEM_SIZE  4096
using namespace std;
int shmid;
static int SharedMemoryInit();
static int SharedMemoryWrite(char *sMemory, int size);
static int SharedMemoryRead(char *sMemory);
int main(int argc, char *argv[])
{
    char buffer[MEM_SIZE] = {0,};
    SharedMemoryInit();
    
    while(1)
    {
        SharedMemoryRead(buffer);
        if(buffer[0] == 1)
        {
            cout << "Receive data from shared memory!" << endl;
            break;
        }    
    }
    return 0;
}

static int SharedMemoryInit()
{
    void *shmaddr;
    
    if((shmid = shmget((key_t)KEY_NUM, 0, 0)) == -1)
    {
        perror("Shmid failed");
    }
    
    return 0;
}

static int SharedMemoryWrite(char *sMemory, int size)
{
    void *shmaddr;
    
    if((shmaddr = shmat(shmid, (void *)0, 0)) == (void *)-1)
    {
        perror("Shmat failed");
    }
    
    memcpy((char *)shmaddr, sMemory, size);
    
    if(shmdt(shmaddr) == -1)
    {
        perror("Shmdt failed");
        exit(1);
    }
    return 0;
}

static int SharedMemoryRead(char *sMemory)
{
    void *shmaddr;
    
    if((shmaddr = shmat(shmid, (void *)0, 0)) == (void *)-1)
    {
        perror("Shmat failed");
    }
    
    memcpy(sMemory, (char *)shmaddr, sizeof(sMemory));
    
    if(shmdt(shmaddr) == -1)
    {
        perror("Shmdt failed");
    }
    
    return 0;
}
```

## ğŸ§ª ì‹¤í–‰ ë°©ë²•
g++ -o shared_memory shared_memory.cpp
./shared_memory


- ë‹¤ë¥¸ í”„ë¡œì„¸ìŠ¤ì—ì„œë„ shm_openìœ¼ë¡œ ë™ì¼í•œ ì´ë¦„ì„ ì—´ë©´ ê°™ì€ ë©”ëª¨ë¦¬ ê³µê°„ì— ì ‘ê·¼ ê°€ëŠ¥
- shm_unlinkëŠ” ê³µìœ  ë©”ëª¨ë¦¬ ê°ì²´ë¥¼ ì‹œìŠ¤í…œì—ì„œ ì œê±°í•˜ë¯€ë¡œ, ëª¨ë“  í”„ë¡œì„¸ìŠ¤ê°€ ì¢…ë£Œëœ í›„ í˜¸ì¶œí•´ì•¼ ì•ˆì „

## âœ… ì¥ì ê³¼ ì£¼ì˜ì‚¬í•­
| í•­ëª© | ì„¤ëª… | 
|------|-----|
| âœ… ì¥ì  | í”„ë¡œì„¸ìŠ¤ ê°„ ë¹ ë¥¸ ë°ì´í„° ê³µìœ  ê°€ëŠ¥ | 
| âœ… ì¥ì  | ì»¤ë„ì´ ê´€ë¦¬í•˜ë¯€ë¡œ ì•ˆì •ì  | 
| âš ï¸ ì£¼ì˜ | ì´ë¦„ ì¶©ëŒ ë°©ì§€ í•„ìš” (/my_shared_memoryëŠ” ê³ ìœ í•˜ê²Œ ì„¤ì •) | 
| âš ï¸ ì£¼ì˜ | shm_unlinkë¥¼ ì ì ˆí•œ ì‹œì ì— í˜¸ì¶œí•´ì•¼ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ | 
| âš ï¸ ì£¼ì˜ | ë™ê¸°í™”ê°€ í•„ìš”í•  ê²½ìš° pthread_mutex + mmap ì¡°í•© ê³ ë ¤ | 



## ğŸ”„ Windowsì™€ ë¹„êµ
| í•­ëª© | Windows | Linux | 
|------|--------|--------|
| API | CreateFileMapping, MapViewOfFile | shm_open, mmap | 
| ì´ë¦„ | ì „ì—­ ì´ë¦„ ì‚¬ìš© ê°€ëŠ¥ | /ë¡œ ì‹œì‘í•˜ëŠ” ê³ ìœ  ì´ë¦„ í•„ìš” | 
| ë™ê¸°í™” | Mutex, Event, Semaphore | pthread_mutex, sem_open ë“± | 

----



